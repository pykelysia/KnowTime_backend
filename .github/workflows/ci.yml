name: CI Tests and Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [1.24.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: go test -v ./...

    - name: Run vet
      run: go vet ./...

    - name: Run fmt
      run: go fmt ./...

  docker-build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: knowtime:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test run container
      run: |
        timeout 10s docker run --rm \
          --env-file <(echo -e "CHAT_MODEL_NAME=gpt-4\nIMAGE_MODEL_NAME=dall-e-3\nBASE_URL=https://api.openai.com\nAPI_KEY=test_key\nJWT_KEY=test_jwt_key_at_least_32_chars_long\nDB_PASSWORD=testpass") \
          knowtime:test || true